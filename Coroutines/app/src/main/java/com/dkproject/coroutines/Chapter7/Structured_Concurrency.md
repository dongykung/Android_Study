# 구조화된 동시성
비동기 작업을 구조화함으로써 비동기 프로그래밍을 보다 안정적이고 예측할 수 있게 만드는 원칙

## 부모 코루틴의 실행환경 상속
부모 코루틴이 자식 코루틴을 생성하면 부모 코루틴의 CoroutineContext가 자식 코루틴에게 전달된다.
즉 부모 코루틴의 실행 환경을 담는 CoroutineContext 객체가 자식 코루틴에게 상속됨.

## 상속되지 않는 Job
launch나 async를 포함한 모든 코루틴 빌더 함수는 호출 때마다 코루틴 추상체인 Job 객체를 새롭게 생성한다.
코루틴 제어에 Job 객체가 필요한데 Job 객체를 부모 코루틴으로부터 상속받게 되면 개별 코루틴의 제어가 어려워지기 때문이다.

## 구조화에 사용되는 Job
자식으로 생성된 Job 객체는 내부에 정의된 parent 프로퍼티를 통해 부모 코루틴의 Job 객체에 대한 참조를 가진다.
부모 코루틴의 Job 객체는 Sequence 타입의 children 프로퍼티를 통해 자식 코루틴의 Job에 대한 참조를 가져 자식 코루틴의 Job 객체와 부모 코루틴의 Job 객체는 양방향 참조를 가진다.

---

## 취소의 전파
코루틴은 자식 코루틴으로 취소를 전파하는 특성을 갖는다.
즉, 특정 코루틴에 취소가 요청되면 취소는 자식 코루틴 방향으로만 전파되며, 부모 코루틴으로는 취소가 전파되지 않는다.
자식 코루틴으로만 취소가 전파되는 이유는 자식 코루틴이 부모 코루틴 작업의 일부이기 때문이다.

## 부모 코루틴의 자식 코루틴에 대한 완료 의존성
부모 코루틴은 모든 자식 코루틴이 실행 완료돼야 완료될 수 있다.
코루틴의 구조화는 큰 작업을 연관된 여러 작은 작업으로 나누는 방식으로 이뤄지는데 작은 작업이 모두 완료돼야 큰 작업이 완료될 수 있기 때문이다.
이를 부모 코루틴이 자식 코루틴에 대해 완료 의존성을 가진다고 한다.

## 실행 완료 중 상태
`실행 완료 중` 상태란 부모 코루틴의 모든 코드가 실행됐지만 자식 코루틴이 실행 중인 경우 부모 코루틴이 갖는 상태를 말한다.
부모 코루틴은 더 이상 실행할 코드가 없더라도 자식 코루틴들이 모두 완료될 때까지 실행 완료될 수 없어 '실행 완료 중' 상태에 머문다.

## CoroutineScope 사용해 코루틴 관리하기
```kotlin
public interface CoroutineScope {
    public val coroutineContext: CoroutineContext
}
```

launch 코루틴 빌더 함수는 CoroutineScope의 확장 함수로 선언돼 있으며, launch 함수가 호출되면 다음 과정을 통해
CoroutineScope 객체로부터 실행 환경을 제공받아 코루틴의 실행 환경을 설정한다.
- 수신 객체인 CoroutineScope로부터 CoroutineContext 객체를 제공받는다.
- 제공받은 CoroutineContext 객체에 launch 함수의 context 인자로 넘어온 CoroutineContext를 더한다
- 생성된 CoroutineContext에 코루틴 빌더 함수가 호출돼 새로 생성되는 Job을 더한다. 이때 CoroutineContext를 통해 전달되는 Job 객체는 새로 생성되는 Job 객체의 부모 Job 객체가 된다.

---
## 구조화와 Job
CoroutineScope 객체를 조작하는 것이 실제로는 CoroutineContext 객체 속의 Job 객체를 조작하는 것이라는 사실!!
코루틴의 구조화의 중심에는 Job 객체가 있다.

## Job객체 생성 시 주의할 점
launch 함수를 통해 생성된 Job 객체는 더 이상 실행할 코드가 없고, 모든 자식 코루틴들이 실행 완료되면 자동으로 실행완료된다.
그러나 Job 생성 함수를 통해 생성된 Job 객체는 자식 코루틴들이 모두 실행 완료되더라도 실행 완료되지 않으며
명시적으로 완료 함수인 complete를 호출해야 한다.